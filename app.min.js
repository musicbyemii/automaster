document.addEventListener("DOMContentLoaded",()=>{let e=document.getElementById("audioFile"),t=document.getElementById("processBtn"),a=document.getElementById("loading"),n=document.getElementById("result"),l=document.getElementById("changesList");document.getElementById("processedAudio");let r=document.getElementById("downloadLink");document.getElementById("originalAudio"),document.getElementById("compareBtn");let o,s,i,d="stable",c,u;c=WaveSurfer.create({container:"#originalWaveform",waveColor:"#888888",progressColor:"#ff4d4d",cursorColor:"#ff4d4d",height:100,responsive:!0,backgroundColor:"transparent"}),u=WaveSurfer.create({container:"#processedWaveform",waveColor:"#888888",progressColor:"#00ff9d",cursorColor:"#00ff9d",height:100,responsive:!0,backgroundColor:"transparent"});let $=!0,f=document.querySelector(".style-selector"),g=document.getElementById("fileUploadLabel");async function p(){let l=e.files[0];if(l){document.querySelector(".upload-section").style.display="none",a.classList.remove("hidden"),t.disabled=!0,document.querySelector(".style-selector").style.display="none";try{o=new(window.AudioContext||window.webkitAudioContext);let d=await l.arrayBuffer();s=await o.decodeAudioData(d),i=await h(s=C(s,!0));let $=A(s),p=A(i);c.loadBlob($),u.loadBlob(p);let v=URL.createObjectURL(p);r.href=v,r.download=`AutoMaster - ${l.name.replace(/\.[^/.]+$/,"")}.wav`,g.classList.add("hidden"),f.classList.add("hidden"),t.classList.add("hidden"),n.classList.remove("hidden"),a.classList.add("hidden")}catch(y){console.error("Processing error:",y),alert(`Error processing audio: ${y.message}`),a.classList.add("hidden"),t.disabled=!1}}}async function h(e){let t=new OfflineAudioContext(e.numberOfChannels,e.length,e.sampleRate),a=t.createBufferSource();a.buffer=e;let{highPass:n,lowPass:l}=v(t),{bassBoost:r,midBoost:o,trebleBoost:s}=y(t),i=b(t),d=_(t),c=t.createGain();a.connect(n).connect(l).connect(r).connect(o).connect(s).connect(i).connect(d).connect(c).connect(t.destination),a.start();let u=await t.startRendering();return C(u)}function v(e){let t=e.createBiquadFilter();t.type="highpass",t.frequency.value=28,t.Q.value=4;let a=e.createBiquadFilter();return a.type="lowpass",a.frequency.value=16500,a.Q.value=1,w("Cut frequencies below 28Hz with steep slope"),w("Cut frequencies above 16.5kHz"),{highPass:t,lowPass:a}}function y(e){let t=m(s),a=e.createBiquadFilter();a.type="lowshelf",a.frequency.value=100,a.gain.value=3;let n=e.createBiquadFilter();n.type="peaking",n.frequency.value=1e3,n.Q.value=1,n.gain.value=2;let l=e.createBiquadFilter();return l.type="highshelf",l.frequency.value=4e3,l.Q.value=.7,"aggressive"===d?t<.3?(l.gain.value=7,w("Applied aggressive treble boost (+7dB)")):t<.5?(l.gain.value=5,w("Applied moderate treble boost (+5dB)")):(l.gain.value=3,w("Applied soft treble boost (+3dB)")):t<.3?(l.gain.value=5,w("Applied strong treble boost (+5dB)")):t<.5?(l.gain.value=3,w("Applied moderate treble boost (+3dB)")):(l.gain.value=1,w("Applied soft treble boost (+1dB)")),w("Applied bass boost (+3dB)"),w("Applied mid-range boost (+2dB)"),{bassBoost:a,midBoost:n,trebleBoost:l}}function m(e){let t=new OfflineAudioContext(e.numberOfChannels,e.length,e.sampleRate),a=t.createBufferSource(),n=t.createAnalyser(),l=t.createBiquadFilter();l.type="highpass",l.frequency.value=4e3,a.buffer=e,a.connect(l),l.connect(n),n.fftSize=2048;let r=new Float32Array(n.frequencyBinCount);a.start(),n.getFloatFrequencyData(r);let o=r.slice(Math.floor(.6*r.length)),s=o.reduce((e,t)=>e+Math.pow(10,t/20),0)/o.length;return s}function b(e){let t=e.createDynamicsCompressor();return t.threshold.value=-24,t.knee.value=10,t.ratio.value="aggressive"===d?4:3,t.attack.value=.01,t.release.value=.25,w(`Applied compression (${t.ratio.value}:1 ratio)`),t}function _(e){var t;let a=e.createStereoPanner(),n;return t=s,Math.abs(n=B(t))>.8&&(a.pan.value=n>0?.25:-.25),w("Applied adaptive stereo imaging"),a}function B(e){if(e.numberOfChannels<2)return 0;let t=e.getChannelData(0),a=e.getChannelData(1),n=0;for(let l=0;l<e.length;l++)n+=t[l]*a[l];return n/e.length}function C(e,t=!1){let a=0,n=e.numberOfChannels,l=e.length;for(let r=0;r<n;r++){let s=e.getChannelData(r);for(let i=0;i<l;i++)a+=s[i]*s[i]}let d=Math.sqrt(a/(n*l)),c=.14;t&&(c=.1);let u=new GainNode(o);u.gain.value=c/d;let $=new AudioBuffer({length:l,numberOfChannels:n,sampleRate:e.sampleRate});for(let f=0;f<n;f++){let g=e.getChannelData(f),p=$.getChannelData(f);for(let h=0;h<l;h++)p[h]=g[h]*u.gain.value}return w("Adjusted loudness to streaming standard"),$}function w(e){let t=document.createElement("li");t.textContent=e,l.appendChild(t)}function A(e){let t=e.numberOfChannels,a=e.sampleRate,n=2*t,l=new Uint8Array(44+e.length*t*2),r=new DataView(l.buffer);q(r,0,"RIFF"),r.setUint32(4,36+e.length*n,!0),q(r,8,"WAVE"),q(r,12,"fmt "),r.setUint32(16,16,!0),r.setUint16(20,1,!0),r.setUint16(22,t,!0),r.setUint32(24,a,!0),r.setUint32(28,a*n,!0),r.setUint16(32,n,!0),r.setUint16(34,16,!0),q(r,36,"data"),r.setUint32(40,e.length*n,!0);let o=44;for(let s=0;s<e.length;s++)for(let i=0;i<t;i++){let d=Math.max(-1,Math.min(1,e.getChannelData(i)[s])),c=d<0?32768*d:32767*d;r.setInt16(o,c,!0),o+=2}return new Blob([l],{type:"audio/wav"})}function q(e,t,a){for(let n=0;n<a.length;n++)e.setUint8(t+n,a.charCodeAt(n))}e.addEventListener("change",e=>{let a=e.target.files[0];if(a){if(!a.type.match(/audio\/(mpeg|flac|wav|x-wav)/)){alert("Please select a valid MP3, FLAC, or WAV file.");return}f.classList.remove("hidden"),t.classList.remove("hidden"),t.disabled=!1,t.addEventListener("click",p),document.querySelector(".file-upload").style.display="none"}}),document.querySelectorAll(".style-btn").forEach(e=>{e.addEventListener("click",()=>{document.querySelectorAll(".style-btn").forEach(e=>e.classList.remove("active")),e.classList.add("active"),d=e.dataset.style})}),c.on("click",()=>{$&&(u.pause(),c.play(),$=!1)}),u.on("click",()=>{$||(c.pause(),u.play(),$=!0)}),u.on("ready",()=>{u.play(),$=!0})});