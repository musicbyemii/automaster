document.addEventListener("DOMContentLoaded",()=>{let e=document.getElementById("audioFile"),t=document.getElementById("processBtn"),n=document.getElementById("loading"),r=document.getElementById("result"),a=document.getElementById("changesList");document.getElementById("processedAudio");let l=document.getElementById("downloadLink");document.getElementById("originalAudio"),document.getElementById("compareBtn");let s,o,i,d="stable",c,u;c=WaveSurfer.create({container:"#originalWaveform",waveColor:"#888888",progressColor:"#ff4d4d",cursorColor:"#ff4d4d",height:100,responsive:!0,backgroundColor:"transparent"}),u=WaveSurfer.create({container:"#processedWaveform",waveColor:"#888888",progressColor:"#00ff9d",cursorColor:"#00ff9d",height:100,responsive:!0,backgroundColor:"transparent"});let $=!0,g=document.querySelector(".style-selector"),p=document.getElementById("fileUploadLabel");async function f(){let a=e.files[0];if(a){document.querySelector(".upload-section").style.display="none",n.classList.remove("hidden"),t.disabled=!0,document.querySelector(".style-selector").style.display="none";try{document.querySelector("#progressText").innerText="Creating audio context...",document.querySelector("#progressBar").style.width="5%",console.log(1),s=new(window.AudioContext||window.webkitAudioContext);let d=await a.arrayBuffer();o=await s.decodeAudioData(d),o=q(o,!0),document.querySelector("#progressText").innerText="Applying mastering chain...",document.querySelector("#progressBar").style.width="15%",i=await y(o),document.querySelector("#progressText").innerText="Creating WAV blobs...",document.querySelector("#progressBar").style.width="75%";let $=w(o),f=w(i);c.loadBlob($),u.loadBlob(f);let h=URL.createObjectURL(f);l.href=h,l.download=`AutoMaster - ${a.name.replace(/\.[^/.]+$/,"")}.wav`,p.classList.add("hidden"),g.classList.add("hidden"),t.classList.add("hidden"),document.querySelector("#progressText").innerText="Finished!",document.querySelector("#progressBar").style.width="100%",r.classList.remove("hidden"),n.classList.add("hidden")}catch(v){console.error("Processing error:",v),alert(`Error processing audio: ${v.message}`),n.classList.add("hidden"),t.disabled=!1}}}async function y(e){let t=new OfflineAudioContext(e.numberOfChannels,e.length,e.sampleRate),n=t.createBufferSource();n.buffer=e;let{highPass:r,lowPass:a}=h(t),{bassBoost:l,midBoost:s,trebleBoost:o}=v(t),i=b(t),d=B(t),c=t.createGain();n.connect(r).connect(a).connect(l).connect(s).connect(o).connect(i).connect(d).connect(c).connect(t.destination),document.querySelector("#progressText").innerText="Starting render...",document.querySelector("#progressBar").style.width="25%",n.start();let u=await t.startRendering();return q(u)}function h(e){let t=e.createBiquadFilter();t.type="highpass",t.frequency.value=28,t.Q.value=4;let n=e.createBiquadFilter();return n.type="lowpass",n.frequency.value=16500,n.Q.value=1,C("Cut frequencies below 28Hz with steep slope"),C("Cut frequencies above 16.5kHz"),{highPass:t,lowPass:n}}function v(e){let t=m(o),n=e.createBiquadFilter();n.type="lowshelf",n.frequency.value=100,n.gain.value=3;let r=e.createBiquadFilter();r.type="peaking",r.frequency.value=1e3,r.Q.value=1,r.gain.value=2;let a=e.createBiquadFilter();return a.type="highshelf",a.frequency.value=4e3,a.Q.value=.7,"aggressive"===d?t<.3?(a.gain.value=7,C("Applied aggressive treble boost (+7dB)")):t<.5?(a.gain.value=5,C("Applied moderate treble boost (+5dB)")):(a.gain.value=3,C("Applied soft treble boost (+3dB)")):t<.3?(a.gain.value=5,C("Applied strong treble boost (+5dB)")):t<.5?(a.gain.value=3,C("Applied moderate treble boost (+3dB)")):(a.gain.value=1,C("Applied soft treble boost (+1dB)")),C("Applied bass boost (+3dB)"),C("Applied mid-range boost (+2dB)"),{bassBoost:n,midBoost:r,trebleBoost:a}}function m(e){let t=new OfflineAudioContext(e.numberOfChannels,e.length,e.sampleRate),n=t.createBufferSource(),r=t.createAnalyser(),a=t.createBiquadFilter();a.type="highpass",a.frequency.value=4e3,n.buffer=e,n.connect(a),a.connect(r),r.fftSize=2048;let l=new Float32Array(r.frequencyBinCount);n.start(),r.getFloatFrequencyData(l);let s=l.slice(Math.floor(.6*l.length)),o=s.reduce((e,t)=>e+Math.pow(10,t/20),0)/s.length;return o}function b(e){let t=e.createDynamicsCompressor();return t.threshold.value=-24,t.knee.value=10,t.ratio.value="aggressive"===d?4:3,t.attack.value=.01,t.release.value=.25,C(`Applied compression (${t.ratio.value}:1 ratio)`),t}function B(e){var t;let n=e.createStereoPanner(),r;return t=o,Math.abs(r=_(t))>.8&&(n.pan.value=r>0?.25:-.25),C("Applied adaptive stereo imaging"),n}function _(e){if(e.numberOfChannels<2)return 0;let t=e.getChannelData(0),n=e.getChannelData(1),r=0;for(let a=0;a<e.length;a++)r+=t[a]*n[a];return r/e.length}function q(e,t=!1){let n=0,r=e.numberOfChannels,a=e.length;for(let l=0;l<r;l++){let o=e.getChannelData(l);for(let i=0;i<a;i++)n+=o[i]*o[i]}let d=Math.sqrt(n/(r*a)),c=.14;t&&(c=.1);let u=new GainNode(s);u.gain.value=c/d;let $=new AudioBuffer({length:a,numberOfChannels:r,sampleRate:e.sampleRate});for(let g=0;g<r;g++){let p=e.getChannelData(g),f=$.getChannelData(g);for(let y=0;y<a;y++)f[y]=p[y]*u.gain.value}return C("Adjusted loudness to streaming standard"),$}function C(e){let t=document.createElement("li");t.textContent=e,a.appendChild(t)}function w(e){let t=e.numberOfChannels,n=e.sampleRate,r=2*t,a=new Uint8Array(44+e.length*t*2),l=new DataView(a.buffer);A(l,0,"RIFF"),l.setUint32(4,36+e.length*r,!0),A(l,8,"WAVE"),A(l,12,"fmt "),l.setUint32(16,16,!0),l.setUint16(20,1,!0),l.setUint16(22,t,!0),l.setUint32(24,n,!0),l.setUint32(28,n*r,!0),l.setUint16(32,r,!0),l.setUint16(34,16,!0),A(l,36,"data"),l.setUint32(40,e.length*r,!0);let s=44;for(let o=0;o<e.length;o++)for(let i=0;i<t;i++){let d=Math.max(-1,Math.min(1,e.getChannelData(i)[o])),c=d<0?32768*d:32767*d;l.setInt16(s,c,!0),s+=2}return new Blob([a],{type:"audio/wav"})}function A(e,t,n){for(let r=0;r<n.length;r++)e.setUint8(t+r,n.charCodeAt(r))}e.addEventListener("change",e=>{let n=e.target.files[0];if(n){if(!n.type.match(/audio\/(mpeg|flac|wav|x-wav)/)){alert("Please select a valid MP3, FLAC, or WAV file.");return}g.classList.remove("hidden"),t.classList.remove("hidden"),t.disabled=!1,t.addEventListener("click",f),document.querySelector(".file-upload").style.display="none"}}),document.querySelectorAll(".style-btn").forEach(e=>{e.addEventListener("click",()=>{document.querySelectorAll(".style-btn").forEach(e=>e.classList.remove("active")),e.classList.add("active"),d=e.dataset.style})}),c.on("click",()=>{$&&(u.pause(),c.play(),$=!1)}),u.on("click",()=>{$||(c.pause(),u.play(),$=!0)}),u.on("ready",()=>{u.play()})});